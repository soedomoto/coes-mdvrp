<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Map</title>

    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/leaflet.css">
    <link rel="stylesheet" href="assets/css/MarkerCluster.css">
    <link rel="stylesheet" href="assets/css/MarkerCluster.Default.css">
    <link rel="stylesheet" href="assets/css/L.Control.Locate.css">
    <link rel="stylesheet" href="assets/css/leaflet.groupedlayercontrol.css">
    <link rel="stylesheet" href="assets/css/app.css">

    <link rel="apple-touch-icon" sizes="76x76" href="assets/img/favicon-76.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/img/favicon-120.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/img/favicon-152.png">
    <link rel="icon" sizes="196x196" href="assets/img/favicon-196.png">
    <link rel="icon" type="image/x-icon" href="assets/img/favicon.ico">
</head>

<body>
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container-fluid">
            <div class="navbar-header">
                <div class="navbar-icon-container">
                    <a href="#" class="navbar-icon pull-right visible-xs" id="nav-btn">
                        <i class="fa fa-bars fa-lg white"></i>
                    </a>
                    <a href="#" class="navbar-icon pull-right visible-xs" id="sidebar-toggle-btn">
                        <i class="fa fa-search fa-lg white"></i>
                    </a>
                </div>
                <a class="navbar-brand" href="#">RT-VRP</a>
            </div>
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li>
                        <a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="about-btn">
                            <i class="fa fa-question-circle white"></i>&nbsp;&nbsp;About</a>
                    </li>
                    <li class="dropdown">
                        <a id="toolsDrop" href="#" role="button" class="dropdown-toggle" data-toggle="dropdown">
                            <i class="fa fa-globe white"></i>&nbsp;&nbsp;Tools <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="full-extent-btn">
                                    <i class="fa fa-arrows-alt"></i>&nbsp;&nbsp;Zoom To Full Extent</a>
                            </li>
                            <li>
                                <a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="legend-btn">
                                    <i class="fa fa-picture-o"></i>&nbsp;&nbsp;Show Legend</a>
                            </li>
                            <li class="divider hidden-xs"></li>
                            <li>
                                <a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="login-btn">
                                    <i class="fa fa-user"></i>&nbsp;&nbsp;Login</a>
                            </li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a class="dropdown-toggle" id="downloadDrop" href="#" role="button" data-toggle="dropdown">
                            <i class="fa fa-cloud-download white"></i>&nbsp;&nbsp;Download <b class="caret"></b>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a href="data/boroughs.geojson" download="boroughs.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in">
                                    <i class="fa fa-download"></i>&nbsp;&nbsp;Boroughs
                                </a>
                            </li>
                            <li>
                                <a href="data/subways.geojson" download="subways.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in">
                                    <i class="fa fa-download"></i>&nbsp;&nbsp;Subway Lines
                                </a>
                            </li>
                            <li>
                                <a href="data/DOITT_THEATER_01_13SEPT2010.geojson" download="theaters.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in">
                                    <i class="fa fa-download"></i>&nbsp;&nbsp;Theaters
                                </a>
                            </li>
                            <li>
                                <a href="data/DOITT_MUSEUM_01_13SEPT2010.geojson" download="museums.geojson" target="_blank" data-toggle="collapse" data-target=".navbar-collapse.in">
                                    <i class="fa fa-download"></i>&nbsp;&nbsp;Museums
                                </a>
                            </li>
                        </ul>
                    </li>
                    <li class="hidden-xs">
                        <a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="list-btn">
                            <i class="fa fa-list white"></i>&nbsp;&nbsp;POI List
                        </a>
                    </li>
                </ul>
            </div>
            <!--/.navbar-collapse -->
        </div>
    </div>

    <div id="container">
        <div class="sidebar">
            <div class="sidebar-wrapper">
                <div class="panel panel-default" id="features">
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            Points of Interest
                            <button type="button" class="btn btn-xs btn-default pull-right" id="sidebar-hide-btn">
                              <i class="fa fa-chevron-left"></i>
                            </button>
                        </h3>
                    </div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-xs-8 col-md-8">
                                <input type="text" class="form-control search" placeholder="Filter" />
                            </div>
                            <div class="col-xs-4 col-md-4">
                                <button type="button" class="btn btn-primary pull-right sort" data-sort="feature-name" id="sort-btn"><i class="fa fa-sort"></i>&nbsp;&nbsp;Sort</button>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-table">
                        <div class="panel-group" id="enumerator-list"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="sidebar" style='float: right; background: #101010; color: white; font-family: "Droid Sans Mono", "Courier New", monospace; font-size: 0.75em;'>
            <div id="console" class="sidebar-wrapper" style="padding: 3px; overflow-y: auto;"></div>
        </div>
        <div id="map"></div>
    </div>

    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <script src="assets/js/eventsource-polyfill.js"></script>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/typeahead.bundle.min.js"></script>
    <script src="assets/js/handlebars.min.js"></script>
    <script src="assets/js/list.min.js"></script>
    <script src="assets/js/leaflet.js"></script>
    <script src="assets/js/leaflet.markercluster.js"></script>
    <script src="assets/js/L.Control.Locate.min.js"></script>
    <script src="assets/js/leaflet.groupedlayercontrol.js"></script>
    <script src="assets/js/leaflet.polylineDecorator.js"></script>
    <script src="assets/js/moment.min.js"></script>
    <script>
        if (window.module) module = window.module;
    </script>

    <script>
        var currentEnumerator = L.icon({
            iconUrl: 'assets/marker/current-enumerator.png',
            iconAnchor: [16, 35],
            popupAnchor: [0, -35]
        });
        var otherEnumerator = L.icon({
            iconUrl: 'assets/marker/other-enumerator.png',
            iconAnchor: [16, 35],
            popupAnchor: [0, -35]
        });
        var unvisitedLocation = L.icon({
            iconUrl: 'assets/marker/unvisited-location.png',
            iconAnchor: [16, 35],
            popupAnchor: [0, -35]
        });
        var visitedLocation = L.icon({
            iconUrl: 'assets/marker/visited-location.png',
            iconAnchor: [16, 35],
            popupAnchor: [0, -35]
        });
        var otherVisitedLocation = L.icon({
            iconUrl: 'assets/marker/other-visited-location.png',
            iconAnchor: [16, 35],
            popupAnchor: [0, -35]
        });

        var serverHost = 'http://localhost:8080';
        var brokerHost = 'localhost';

        // Connection
        var redis = require("redis");
        var cache = redis.createClient(6379, brokerHost);
        var subscriber = redis.createClient(6379, brokerHost);
        var publisher = redis.createClient(6379, brokerHost);

        // Cache objects
        var locationsCache = {};
        var enumeratorsCache = {};
        var subscribedDepot = "";

        jQuery(document).ready(function() {
            // create the tile layer with correct attribution
            var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var osmAttrib = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors';
            var osm = new L.TileLayer(osmUrl, {
                minZoom: 2,
                maxZoom: 20,
                attribution: osmAttrib
            });

            // set up the map
            map = new L.Map('map');
            map.setView(new L.LatLng(-1.348051, 100.581783), 9);
            map.addLayer(osm);
            L.control.scale().addTo(map);

            // Load all locations
            cache.get("locations", function(err, locations) {
                if (locations !== null) {
                    locations = JSON.parse(locations);
                    locations.forEach(function(location) {
                        var marker = L.marker([location.lat, location.lon], {
                            icon: unvisitedLocation
                        }).addTo(map);
                        marker.bindPopup('<b>' + location.id + '</b><br>I am a job.');

                        locationsCache[location.id] = {
                            'location': location,
                            'marker': marker,
                        }
                    });
                }
            });

            // List all enumerators
            cache.get("enumerators", function(err, enumerators) {
                if (enumerators !== null) {
                    enumerators = JSON.parse(enumerators);
                    var list = $('#enumerator-list');
                    enumerators.forEach(function(enumerator) {
                        enumeratorsCache[enumerator.id] = enumerator;

                        $('<div class="panel panel-default">' +
                            '<div class="panel-heading">' +
                            '<h4 class="panel-title">' +
                            '<a data-toggle="collapse" data-parent="#enumerator-list" href="#collapse-' + enumerator.id + '">' +
                            '<span class="fa fa-arrow-circle-o-right"></span>' + enumerator.id +
                            '</a>' +
                            '</h4>' +
                            '</div>' +
                            '<div id="collapse-' + enumerator.id + '" class="panel-collapse collapse">' +
                            '<div class="panel-body">' +
                            '<div><a href="#" class="btn-use-it" data-enumerator="' + enumerator.id + '">' +
                            'Use this enumerator <i class="fa fa-chevron-right pull-right"></i>' +
                            '</a></div>' +
                            '<div><a href="#" class="btn-start-it" data-enumerator="' + enumerator.id + '">' +
                            'Start this enumerator <i class="fa fa-chevron-right pull-right"></i>' +
                            '</a></div>' +
                            '</div>' +
                            '</div>' +
                            '</div>').data(enumerator).appendTo(list);
                    });
                }
            });

            // current enumerator
            var enumeratorMarker;
            $(document).on('click', '.btn-use-it', function() {
                id = $(this).data('enumerator');
                enumerator = enumeratorsCache[id];
                depot = locationsCache[enumerator.depot]['location'];
                subscriber.unsubscribe(subscribedDepot);

                if (enumeratorMarker !== undefined) map.removeLayer(enumeratorMarker)
                enumeratorMarker = L.marker([depot.lat, depot.lon], {
                    icon: currentEnumerator
                }).addTo(map);
                enumeratorMarker.bindPopup('<b>' + enumerator.id + '</b><br>I am an enumerator.').openPopup();

                map.setView(new L.LatLng(depot.lat, depot.lon), 12);

                // Change marker of visited locations
                for (var eId in enumeratorsCache) {
                    loadVisitedLocations(eId, eId == enumerator.id);
                }

                // Make route of visited locations
                // loadLocationRoutes(enumerator.id)
            });

            var polylineCache = [];

            function loadVisitedLocations(enumeratorId, isCurrentEnumerator) {
                polylineCache.forEach(function(pl) {
                    map.removeLayer(pl);
                });
                polylineCache = [];

                cache.get("enumerator." + enumeratorId + ".visits", function(err, locations) {
                    if (locations !== null) {
                        locations = JSON.parse(locations);
                        for (var l = 0; l < locations.length; l++) {
                            var loc = locations[l];

                            // Change marker
                            var marker = L.marker([loc.lat, loc.lon], {
                                icon: isCurrentEnumerator ? visitedLocation : otherVisitedLocation
                            }).addTo(map);
                            marker.bindPopup('<b>' + loc.id + '</b><br>I am a visited job.');

                            if (loc.id in locationsCache) {
                                map.removeLayer(locationsCache[loc.id]['marker'])
                                locationsCache[loc.id]['marker'] = marker;
                            }

                            if (isCurrentEnumerator) {
                                // Add routes polyline
                                if (l == 0) {
                                    var enumerator = enumeratorsCache[enumeratorId];
                                    var locA = locationsCache[enumerator.depot]['location'];
                                } else {
                                    var locA = locations[l - 1];
                                }
                                var locB = locations[l];

                                var polyline = new L.polyline([new L.LatLng(locA.lat, locA.lon), new L.LatLng(locB.lat, locB.lon)], {
                                    color: 'red',
                                    weight: 3,
                                    opacity: 0.8,
                                    smoothFactor: 1,
                                }).addTo(map);

                                var decorator = L.polylineDecorator(polyline, {
                                    patterns: [{
                                        offset: '60%',
                                        repeat: 0,
                                        symbol: L.Symbol.arrowHead({
                                            pixelSize: 15,
                                            polygon: false,
                                            pathOptions: {
                                                stroke: true,
                                                color: 'red',
                                                weight: 3,
                                                opacity: 0.8,
                                                smoothFactor: 1,
                                            }
                                        })
                                    }]
                                }).addTo(map);

                                polylineCache.push(polyline);
                                polylineCache.push(decorator);
                            }
                        }
                    }
                });
            }

            $(document).on('click', '.btn-start-it', function() {
                id = $(this).data('enumerator');
                enumerator = enumeratorsCache[id];
                subscribeLocation(enumerator, enumerator.depot);
            });

            function subscribeLocation(enumerator, depot) {
                log(enumerator.id, moment().format() + ' : ' + enumerator.id + ' is subscribing new location');

                subscriber.on('message', function(channel, location) {
                    location = JSON.parse(location);

                    log(enumerator.id, moment().format() + ' : ' + enumerator.id + ' got new location');
                    travelToLocation(enumerator, location);

                    subscriber.unsubscribe(channel);
                });
                subscriber.subscribe('depot.' + depot);
                subscribedDepot = depot;
            }

            function travelToLocation(enumerator, location) {
                duration = location['duration'] * 10;
                log(enumerator.id,
                    moment().format() + ' : ' + enumerator.id + ' is traveling to ' + location['location'] + ' for ' +
                    (duration / 1000) + ' secs');

                setTimeout(function(enumerator, location) {
                    log(enumerator.id,
                        moment().format() + ' : ' + enumerator.id + ' is arrived in ' + location['location']);

                    // Move enumerator marker
                    latDest = location['location-coord'][0];
                    lonDest = location['location-coord'][1];
                    enumeratorMarker.setLatLng(new L.LatLng(latDest, lonDest));

                    // Create line between old an new point
                    latOri = location['depot-coord'][0];
                    lonOri = location['depot-coord'][1];
                    new L.polyline([new L.LatLng(latOri, lonOri), new L.LatLng(latDest, lonDest)], {
                        color: 'red',
                        weight: 3,
                        opacity: 0.5,
                        smoothFactor: 1,
                    }).addTo(map);

                    collectingData(enumerator, location);
                }, duration, enumerator, location);
            }

            function collectingData(enumerator, location) {
                publishVisit(enumerator, location);

                duration = location['service-time'] * 10;
                log(enumerator.id,
                    moment().format() + ' : ' + enumerator.id + ' is collecting data in ' + location['location']);

                setTimeout(function(enumerator, location) {
                    log(enumerator.id,
                        moment().format() + ' : ' + enumerator.id + ' is finish collecting data in ' +
                        location['location'] + ' for ' + (duration / 1000) + ' secs');

                    subscribeLocation(enumerator, location['location'])
                }, duration, enumerator, location);
            }

            function publishVisit(enumerator, location) {
                var receivers = publisher.publish('enumerator.' + enumerator.id + '.visit',
                    location['location'] + ' ' + Date.now());
                if (receivers == 0) {
                    $('<div>No receivers. Try again...</div>').appendTo($('#console'));
                    publishVisit(enumerator, location);
                } else {
                    var loc = locationsCache[location['location']]['location'];
                    var marker = L.marker([loc.lat, loc.lon], {
                        icon: visitedLocation
                    }).addTo(map);
                    marker.bindPopup('<b>' + loc.id + '</b><br>I am a visited job.');

                    if (loc.id in locationsCache) {
                        map.removeLayer(locationsCache[loc.id]['marker'])
                        locationsCache[loc.id]['marker'] = marker;
                    }
                };
            }

            function log(enumerator, message) {
                $('<div>' + message + '</div>').appendTo($('#console'));

                var receivers = publisher.publish('log.' + enumerator, message);
                if (receivers == 0) {
                    $('<div>No receivers. Try again...</div>').appendTo($('#console'));
                    log(enumerator, message);
                };
            }
        });
    </script>
</body>

</html>
